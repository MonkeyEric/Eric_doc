[视频地址](https://www.bilibili.com/video/BV1kJ411p7mV?p=9&spm_id_from=pageDriver)

[toc]

## 1. 持续集成流程说明
![img.png](../../img/chiXuJiCheng.png)

1. 首先，开发人员进行代码提交，提交到git仓库
2. 然后，jenkins作为持续集成工具，使用git工具到git仓库拉取代码到服务器，再配合JDK，Maven等软件完成代码编译，代码测试与审查，测试，打包等工作，在这个过程中每一步出错，都重新再执行一次整个流程。
3. 最后，jenkins把生成的jar或war包分发到测试服务器或者生产服务器，测试人员或用户就可以访问应用。

服务器列表：统一采用centos7
   
| 名称 | IP地址  | 安装的软件  |
|:--------| :---------:| :---------:|
|代码托管服务器 |- |gitlab-12.4.2 |
|持续集成服务器 |- |jenkins,JDK,Maven,Git,SonarQube |
|应用测试服务器 |- |JDk，Tomcat |

### 1. jenkins的安装
* 安装JDK。jenkins需要依赖JDK，所以需要安装JDK
```shell
yum install java-1.8.0-openjdk* -y
```
1. 获取jenkins安装包
下载页面：https://www.jenkins.io/zh/download/
```shell
wget http://mirrors.jenkins-ci.org/redhat/jenkins-2.338-1.1.noarch.rpm
```
2. 把安装包上传到服务器进行安装
```shell
rpm -ivh 2.190.3-1.1.noarch.rpm
```
3. 修改jenkins配置
```shell
vim /etc/sysconfig/jenkins
```
修改内容如下：
```shell
JENKINS_USER="admin"
JENKINS_PORT="8080"
``` 
4. 启动jenkins
```shell
systemctl start jenkins
```
5. 打开浏览器访问
http://+ip地址:8888
6. 获取并输入admin账户密码
```shell
cat /var/lib/jenkins/secrets/initialAdminPassword
```
[jenkins忘记密码解决方法](https://www.jb51.net/article/176613.htm)
7. 选择推荐插件安装
jenkins默认是有一个admin账户的，所以在创建管理员的时候，也可以以admin的身份创建

### 2. jenkins插件管理
jenkins本身不提供很多功能，我们可以通过使用插件来满足我们的使用。例如从gitlab拉取代码，使用Maven构建项目等功能需要依靠插件完成。
1. 修改jenkins插件下载地址
jenkins->Manage Jenkins -> Manage Plugins，点击Available
这样做的是为了把jenkins官方的插件列表下载到本地，接着修改地址文件，替换为国内插件地址
```shell
cd /var/lib/jenkins/updates
sed -i 's/http:\/\/updates.jenkins-ci.org\/download/https:\/\/mirrors:tuna.tsinghua.edu.cn\/jenkins/g' default.json && sed -i 's/http:\/\/wwww.google.com/https:\/\/www.baidu.com/g' default.json
```
最后，manage plugins 点击advanced,把update Site改为国内插件地下地址
```shell
https://mirrors.tuna.tsinghua.edu.cn/jenkins/updates/update-center.json
```

submit后，在浏览器输入:http://ip地址+:8888/restart重启jenkins

### 3. jenkins用户权限管理
我们可以利用role-based Authorization Strategy插件来管理Jenkins用户权限
* 安装role-based Authorization Strategy插件
* 系统管理->开启权限全局安全配置。授权策略切换为Role-Based　strategy，保存
* 如果出现的问题，需要安装Authorize Project的插件，要不然，分类的角色用户，后期有问题
```shell
Builds in Jenkins run as the virtual Jenkins SYSTEM user with full Jenkins permissions by default. This can be a problem if some users have restricted or no access to some jobs, but can configure others. If that is the case, it is recommended to install a plugin implementing build authentication, and to override this default.
```

1. 创建角色
* 在系统管理页面进入Manage and Assign Roles
* 点击Manage Roles


        * Global roles（全局角色）：管理员等高级用户可以创建基于全局的角色
        * Project roles(项目角色)：针对某个或者某些项目的角色
        * Slave roles(奴隶角色)：节点相关的权限

2. 创建用户
在系统管理页面进入Manage User
分别创建两个用户：jack和eric
3. 给用户分配角色

系统管理页面进入Manage and Assign Roles，点击Assign Roles
绑定规则如下:
* eric用户分别绑定baseRole和Role1角色
* jack用户分别绑定baseRole和Role2角色

4. 新建任务来对以上用户角色进行测试

### 4. jenkins用户凭证管理
凭据可以用来存储需要密文保护的数据库密码、gitlab密码信息、Docker私有仓库密码等，以便jenkins可以和这些第三方的应用进行交互。
1. 安装Credentials Bindings插件

* 要在jenkins使用凭证管理功能，需要安装Credentials Binding插件
* 安装插件 **如果在安装jenkins的时候，选择推荐插件安装，该插件已经安装上**
* 进入系统配置——凭证配置——新增——Jenkins凭据提供者——选择以下五种凭证
> 可以添加的凭证有5种：

1. Username with password: 用户名和密码
2. SSH Username with private key：使用ssh用户和密钥
3. Secret file: 保密的文本文件，使用时jenkins会将文件复制到一个临时目录中，再将文件路径设置到一个变量中，等构建结束后，所复制的Secret file就会被删除。
4. Secret Text: 需要保存的一个加密的文本串，如钉钉机器人或Github的api token
5. Certificate: 通过上传证书文件的方式
常用的凭证类型有：**Username with password** 和 **SSH Username with private key**

接下来使用Git工具到Gitlab拉取项目源码为例，演示jenkins的如何管理Gitlab的凭证。

2. 安装Git插件和Git工具
为了让jenkins支持从Gitlab拉取源码，需要安装Git插件以及在cenots上安装工具。

Git插件安装： 插件管理——搜索Git——安装
Centos上安装Git工具： 
```shell
yum install git -y 
git --version
```
3. 用户密码类型
   
    1. 创建凭证
    jenkins——凭证——系统——全局凭证——添加凭证


4. SSH密钥类型
ssh免密登录示意图
![img.png](../../img/miyao.png)
   
    1. 使用root用户生成公钥和私钥
    ```shell
    ssh-keygen -t rsa
    ```
   
        在/root/.ssh/目录保存了公钥和私钥
        * id_rsa: 私钥文件
        * id_rsa.pub ：公钥文件
    
    2. 把生成的公钥放在gitlab中
    
        以root账户登录——点击头像——Settings——SSH keys
        
        复制刚才id_rsa.pub文件的内容到这里，点击“Add key”

### 5. Maven的安装和配置 [官网](https://maven.apache.org/download.cgi)

maven的作用：在持续集成的服务器上，进行编译、代码审查、打包的工作

***
1. 安装maven
先上传maven软件到持续集成的服务器上
```shell
tar -xzf apache-maven-3.6.2-bin.tar.gz 解压
mkdir -p /opt/maven
mv apache-maven-3.6.2/* /opt/maven 移动文件
```   

2. 配置环境变量

[如何找到JAVA_HOME](https://www.cnblogs.com/caotao0918/p/10734084.html)
```shell
vi /etc/profile
export JAVA_HOME=/usr/lib/jvm/java-1.8.0-openjdk
export MAVEN_HOME=/opt/maven
export PATH=$PATH:$JAVA_HOME/bin:$MAVEN_HOME/bin
source /etc/profile 配置失效
mvn -v 查找maven脚本
```
3. 全局工具配置关联JDK和Maven
jenkins——Global Tool Configuration——JDK——新增JDK，配置如下：
![img.png](../../img/add_jdk.png)   
   
jenkins——Global Tool Configuration——Maven——新增Maven，配置如下：
![img.png](../../img/add_maven.png)   

4. 添加jenkins全局变量
设置——全局属性——环境变量,添加全局变量JAVA_HOME、M2_HOME、PATH+EXTRA
![img.png](../../img/global.png)

5. 修改Maven的settings.xml
```shell
mkdir /root/repo 创建本地仓库目录
vi /opt/maven/conf/settings.xml
```

本地仓库改为:
```shell
<localRepository>/root/repo
</localRepository>
```

添加阿里云私服地址：
```xml
<mirror>
<id>alimaven</id>
<name>aliyun maven</name>
<url>http://maven.aliyun.com/nexus/content/groups/public/</url>
<mirrorOf>central</mirrorOf>
</mirror>
```

6. 测试Maven是否配置成功
使用之前的gitlab密码测试项目，点击配置——构建——增加构建步骤——Execute shell
```shell
输入 mvn clean package
```
***


### 6. Tomcat服务器安装和配置 /汤姆凯特/
可以作为测试服务器或者生产服务器，通过jenkins远程打包到服务器上。管理web项目
***
1. 安装Tomcat8.5
```shell
yum install java-1.8.0-openjdk* -y 安装JDK 
tar -xzf apache-tomcat-8.5.47.tar.gz 解压
mkdir -p /opt/tomcat 创建目录
mv /root/apache-tomcat-8.5.47/* /opt/tomcat 移动文件
/opt/tomcat/bin/startup.sh 启动tomcat
```
注意:服务器已经关闭了防火墙，所以可以直接访问Tomcat辣

地址为:http://ip地址:8080

2. 配置Tomcat用户角色与权限
当你点击上述页面的manage app，出现403 access denied。默认情况下Tomcat是没有配置用户角色权限的。但是，后续jenkins部署项目到Tomcat服务器，需要用到Tomcat的用户，所以修改Tomcat以下配置，添加用户及权限。
```shell
vim /opt/tomcat/conf/tomcat-users.xml
```   
内容如下：
```xml
<tomcat-users>
    <role rolename="tomcat"/>
    <role rolename="role1"/>
    <role rolename="manager-script"/>
    <role rolename="manager-gui"/>
    <role rolename="manager-status"/>
    <role rolename="admin-gui"/>
    <role rolename="admin-script"/>
    <user username="tomcat" password="tomcat" roles="manager-gui,manager-script,tomcat,admin-gui,admin-script"></user>
</tomcat-users>
```
用户密码都是:tomcat

注意：为了能让刚才配置的用户登录到tomcat，还需要修改以下配置：
```shell
vim /opt/tomcat/webapps/manager/META-INF/context.xml
<!--
  <value className="org.apache.catalina.valves.RemoteAddrValve" allow="127\.\d+\.\d+\.\d+|::1|0:0:0:0:0:0:0:1"/>
-->
```
把上边的这行注释掉
3. 重启Tomcat，访问测试
```shell
/opt/tomcat/bin/shutdown.sh 停止
/opt/tomcat/bin/startup.sh 启动
```
访问:http://ip地址:8080/manager/html,输入tomcat和tomcat，就可以了
***   

## 2. Gitlab代码托管服务器安装
### 1. Gitlab简介
[Gitlab]()是一个用于仓库管理系统的开源项目，使用git作为代码管理工具，并在此基础上行搭建起来的Web服务。

Gitlab和Github的区别：

**相同点**：
* 属于第三方基于Git开发的作品
* 免费且开源(基于MIT协议)
* 可以注册用户，任意提交你的代码，添加SSHKey等

**不同点**:
* Gitlab可以部署到自己的服务器上，数据库等一切信息掌握到自己的手上，适合团队内部写作开发
* Github的项目，不管是私人还是公共的都是在Github服务器上的，一定程度上不安全
* Github的响应有点慢，没有自己或公司搭建的Gitlab方便。

### 2. Gitlab安装
1. 安装相关依赖
```shell
yum install policycoreutils openssh-server openssh-clients postfix
```
2. 启动ssh服务&设置为开机启动
```shell
systemctl enable sshd && sudo systemctl start sshd
```
3. 设置postfix开机自启，postfix支持gitlab发信功能
```shell
systemctl enable postfix && systemctl start postfix
```
4. 开放ssh以及http服务，然后重新加载防火墙列表
```shell
firewall-cmd --add-service=ssh --permanent
firewall-cmd --add-service=http --permanent
firewall-cmd --reload

```
如果关闭防火墙就不需要做以上配置
5. 下载gitlab，并安装
[官网](https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/)
   
按照centos的版本来进行选择，以下是按照centos7来安装的(el7)
```shell
wget https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el7/gitlab-ce-14.7.4-ce.0.el7.x86_64.rpm
```
安装:
```shell
rpm -i 安装包
```
6. 修改gitlab配置
```shell
vim /etc/gitlab/gitlab.rb
```
修改gitlab访问地址和端口，默认为80，我们改为82
```shell
external_url 'http://101.43.171.188:82'
nginx['listen_port'] = 82
```
7. 重载配置及启动gitlab[这个动作会要求服务器的内存很大，因为会开启很多服务]
```shell
gitlab-ctl reconfigure
gitlab-ctl restart
```

8. 把端口添加到防火墙
```shell
firewall-cmd --zone=public --add-port=82/tcp --permanent
firewall-cmd --reload
```
启动成功后，看到修改管理员root密码的页面，修改密码后，然后登录即可

### 3. gitlab添加组、创建用户、创建项目
1. 创建组
使用管理员root创建组，一个组里面可以有多个项目分支，可以将开发添加到组里面进行设置权限，不同的组就是不同公司的开发项目或者服务模块，不同的组添加不同的开发即可实现对开发设置权限管理。
gitlab用户在组里面有5种不同的权限：
* Guest：可以创建issue，发表评论，不能读写版本库
* Reporter：可以克隆代码，不能提交，QA、PM可以赋予这个权限
* Developer：可以克隆代码、开发、提交、push，普通开发可以赋予这个权限
* Maintainer：可以创建项目、添加Tag、保护分支、添加项目成员、编辑项目，核心开发可以赋予这个权限
* Owner：可以设置项目访问权限-visibility Level、删除项目、迁移项目、管理组成员，开发组组长可以赋予这个权限

2. 创建用户的时候，可以选择Regular和Admin类型，创建完用户后，立即修改密码
3. 将用户添加到组中。选择某个用户组，进行Members管理的成员
4. 在用户组创建项目，以刚才创建的新用户身份登录到Gitlab，然后在用户组中创建新的项目

