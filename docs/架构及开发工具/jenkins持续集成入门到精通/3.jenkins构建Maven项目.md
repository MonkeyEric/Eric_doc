# 1. jenkins项目构建类型介绍
## 1.1 类型介绍
jenkins中自动构建项目的类型有很多，常用的有以下三种：
* 自由风格软件项目
* Maven项目
* 流水线项目

每种类型的构建其实都可以完成一样的构建过程与结果，只是在操作方式、灵活度等方面有所区别，在实际开发红可以根据自己的需求来选择

## 1.2. 自由风格项目构建
过程：拉取代码-编译-打包-部署
* 拉取代码
    
    1. 创建项目
    2. 配置源码管理，从gitlab拉取代码
  
* 编译打包
构建——添加构建步骤——Executor shell
```shell
echo "开始编译和打包"
mv clean package
echo "编译和打包结束"
```  
* 部署
把项目部署到远程的Tomcat里
  
  1. 安装Deploy to container插件。jenkins本身无法实现远程部署到Tomcat的功能，需要安装Deploy to container插件实现
  2. 点击构建后操作
  3. 在WAR/EAR files中输入war的存放地址:target/*.war[mvn clean package 打包好的war包地址],context path 省略
  4. add containers 选择Tomcat对应的版本。credentials凭证，新添加，选择 username With password
  5. 添加Tomcat用户凭证，就是在Tomcat中建立的账号和密码。
  6. tomcat url http://地址:8080端口
  7. 点击构建
  8. 在tomcat的页面刷新，新的项目就出来了，点击项目，项目的主页就可以看到了
  
* 演示改动代码后的持续集成:
1. IDEA中源码修改并提交到gitlab
2. 在jenkins中项目重新构建
3. 访问Tomcat



## 1.3. Maven项目构建
1. 安装Maven Integration擦肩
2. 创建Maven项目
3. 配置项目。拉取代码和远程部署的过程和自由风格一样，只是“构建”部分不同
4. Root PoM，默认会在项目根目录下有一个pom.xml,Goals and options 直接输入clean package
5. 构建后操作，同上
## 1.4. Pipeline流水线项目构建(*)
1. 概念
Pipeline，简单来说，就是一套运行在jenkins上的工作流程，将原来独立运行于单个或者多个节点的任务连接起来，实现单个任务难以完成的复杂流程编排和可视化的工作。
2. 使用Pipeline有以下好处:

    * 代码： Pipeline以代码的形式实现，通常被检入源代码控制，使团队能够编辑，审查和迭代其传送流程。
    * 持久： 无论使计划内还是计划外的服务器重启，Pipeline都是可以恢复的
    * 可停止：Pipeline可接受交互式输入，以确定是否继续执行Pipeline
    * 多功能： Pipeline支持现实世界中复杂的持续交付要求，他支持fork/join、循环执行，并执行任务的功能
    * 可扩展： Pipeline插件支持其DSL的自定义扩展,以及与其他插件集成的多个选项
  
3. 如何创建jenkins Pipeline呢？

    * Pipeline脚本使由Groovy实现的，但是没必要单独去学习Groovy
    * Pipeline支持两种语法：Declarative (声明式)和Scripted Pipeline(脚本式语法)
    * Pipeline也有两种创建方法：可以直接在jenkins的Web Ui界面中输入脚本；也可以通过创建一个Jenkinsfile脚本文件放入项目源码库中(一般都推荐在jenkins中直接从源代码控制(SCM)中直接载入Jenkinsfile pipeline这种方法)
4. 安装Pipeline插件

    
    Manage jenkins——Manage Plugins——可选插件
    安装插件后，创建项目的时候多了“流水线”类型
5. Pipeline语法快速入门
  
    1. Declarative声明式 Pipeline：创建项目——流水线——选择Hello模板
  
    ![img.png](../../img/declar_pipeline.png)

    2. Pipeline script，创建项目——流水线——选择Scripted Pipeline模板

6. 拉取代码
   
    * 点击流水线语法——片段生成器——选择checkout (拉取代码)——设置Repository URL以及凭证——选择分支——生成流水线脚本
    * 输入到pipeline中
    * 构建
7. 编译打包
> build project

    * 同上，选择片段生成器，选择shell Script,输入 mvn clean package 生成pipeline流水线脚本
    * 加入到 build project中，应用，保存
    * 构建


8. 部署
> publish project

    * 片段生成器——deploy:Deploy war/ear to a container,填写war files的路径，和之前的一样，context path忽略，设置containers，添加Tomcat的账户密码、地址
    * 生成流水线脚本
    * 添加到publish project中的 steps中
    * 应用，保存，构建
如图所示：

![img.png](../../img/publish.png)
9. Pipeline Script from SCM
> 1. 版本更换了，脚本更换起来比较麻烦
> 2. 服务器崩溃了，脚本也会丢失
> 3. 总的来说：jenkins的UI界面，存放脚本是不太方便，推荐的形式，将脚本存放到项目下面，当每次推到服务器的时候，可以用脚本文件做好版本控制 '


解决方法：
>1. 在项目的根目录下，建立一个Jenkinsfile的文件，名字尽量不要做更改，然后将UI界面上的脚本，都剪切粘贴到该文件里边了，然后推送到代码仓库中。
> 2. 流水线选择Pipeline script from SCM,SCM选择Git，填写仓库地址以及认证，脚本路径写Jenkinsfile，我们推荐是放到项目跟目录下，
> 3. 点击应用、保存、构建



# 2. 构建细节
## 2.1 常用构建触发器
jenkins内置4种构建触发器：
* 触发工程构建
* 其他工程构建后触发(Build after other projects are build)
* 定时构建(Build periodically)
* 轮询SCM(Poll SCM)

### 触发构建
![img.png](../../img/chufa_token.png)
触发构建url:  

http://192.168.66.10.1:8888/job/web_demo_pipeline/build?token=6666
### 其他工程构建后触发
选择build after other
1. 创建pre_job流水线工程
2. 配置需要触发的工程,输入上边建立的流水线工程名称
3. pre_job构建完毕之后，才会触发第二步的工程
### 定时规则
我们可以设定一个定时规则，
定时字符串从左往右分别为：分 时 日 月 周

一些定时表达式的例子：
```
每30分钟构建一次：H代表形参
H/30 * * * *   10:02  10:32
每2个小时构建一次:
H H/2 * * * 
每天的8点，12点，22点，一天构建三次：（多个时间点中间用逗号隔开）
0 8,12,22 * * *
每天中午12点定时构建一次
H 12 * * *
每天下午18点定时构建一次
H 18 * * *
在每个小时的前半个小时内的每10分钟
H(0-29)/10 * * * *
每两个小时一次，每个工作日上午9点到下午5点(也许是上午10：38，下午12：38，下午2：38，下午4：38)
H H(9-16)/2 * * 1-5
```

### 轮询SCM
轮询SCM，是指定时扫描本地代码仓库的代码是否有变更，如果代码有变更就触发项目构建
注意：这次构建触发器，Jenkins会定时扫描本地整个项目的代码，增大系统的开销，不建议使用
## 2.2 Git hook自动触发构建
上述的jenkins的内置构建触发器中，轮询SCM可以实现Gitlab代码更新，项目自动给构建，但是该方案性能不佳，有没有更好的方案呢？

有的，就是利用Gitlab的webhook代码实现代码push到仓库，立即触发项目自动构建
![img.png](../../img/githook.png)

### 安装Gitlab Hook插件(如果是github，是github hook插件)
需要安装两个插件：Gitlab Hook和Gitlab
### jenkins设置自动构建
 
configure—— 勾选Allow requests to the local network from web hooks and services——save changes
项目的settings——integrations——URL就是上述步骤中的URL——Trigger选择相应的行为（此处选择push events）——可以选择test来进行测试


## 2.3 jenkins的参数化构建
## 2.4 配置邮箱服务器发送构建结果

# 3. jenkins+SonarQube代码审查
## 3.1 安装SonarQube
## 3.2 实现代码审查


